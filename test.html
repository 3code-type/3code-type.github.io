<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>三碼中文輸入法</title>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="./3code2_files/css2" rel="stylesheet">
    <style>
        /* 基礎樣式與變數定義 */
        :root {
            --primary-color: #3f51b5;
            --primary-light: #5c6bc0;
            --text-color: #212121;
            --background-color: #f5f6fa;
            --container-bg: #ffffff;
            --border-color: #e0e0e0;
            --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            --key-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --unified-font-size: 20px;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--background-color);
            padding: 20px;
            color: var(--text-color);
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: calc(var(--unified-font-size) + 8px);
        }

        .container {
            width: 95%;
            max-width: 800px;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .input-group,
        .output-section,
        .practice-area,
        .search-area,
        .keyboard-layout {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--background-color);
        }
        
        .output-section {
            background-color: #e8eaf6;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .practice-area {
            background-color: #e8f5e9;
            min-height: 100px;
        }

        .input-display {
            font-size: var(--unified-font-size);
            font-weight: bold;
            color: #d32f2f;
            word-wrap: break-word;
            word-break: break-all;
        }

        .phrase-lookup {
            font-size: var(--unified-font-size);
            color: var(--primary-color);
            word-wrap: break-word;
            word-break: break-all;
        }

        .candidates-display {
            font-size: var(--unified-font-size);
            color: #388e3c;
            word-wrap: break-word;
            word-break: break-all;
        }

        .candidate-item {
            display: inline-block;
            cursor: pointer;
            padding: 2px 5px;
            margin: 2px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .candidate-item.selected {
            background-color: var(--primary-color);
            color: #fff;
        }

        .search-input {
            width: calc(100% - 20px);
            padding: 10px;
            font-size: var(--unified-font-size);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .mode-display {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            text-align: right;
            margin-bottom: 10px;
        }

        .keyboard-layout {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 5px;
            background-color: #cfd8dc;
            padding: 10px;
            border-radius: 8px;
        }

        .key {
            padding: 10px 5px;
            background-color: #fff;
            border: 1px solid #90a4ae;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: var(--key-shadow);
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.1s;
            position: relative;
        }

        .key:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .key-text {
            display: block;
            font-size: 1.2em;
        }

        .key-subtext {
            font-size: 0.8em;
            color: #757575;
            position: absolute;
            bottom: 2px;
            right: 4px;
        }

        /* 特殊按鍵的樣式 */
        .key-space { grid-column: span 3; }
        .key-shift { grid-column: span 2; }
        .key-backspace { grid-column: span 2; }
        .key-enter { grid-column: span 2; }

        @media (max-width: 600px) {
            .keyboard-layout {
                grid-template-columns: repeat(10, 1fr);
            }
            .key-space { grid-column: span 4; }
            .key-shift { grid-column: span 2; }
            .key-backspace { grid-column: span 2; }
            .key-enter { grid-column: span 2; }
        }
        
        /* 選字區分頁控制按鈕樣式 */
        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .pagination-controls button {
            padding: 8px 15px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            border-radius: 5px;
            background-color: #fff;
            color: var(--primary-color);
            transition: background-color 0.2s, color 0.2s;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-controls button:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: #fff;
        }
    </style>
</head>
<body>

    <h1>三碼中文輸入法</h1>

    <div class="container">
        <div class="output-section">
            <div id="mode-display" class="mode-display"></div>
            <div id="practice-area" class="practice-area"></div>
            <div id="input-display" class="input-display"></div>
            <div id="phrase-lookup" class="phrase-lookup"></div>
            <div id="candidates-display" class="candidates-display"></div>
            <div id="pagination-controls" class="pagination-controls" style="display: none;">
                <button id="prevPage">上一頁</button>
                <button id="nextPage">下一頁</button>
            </div>
        </div>
        
        <div class="search-area">
            <h3>反向查詢</h3>
            <input type="text" id="searchInput" class="search-input" placeholder="輸入單一漢字查詢編碼">
            <div id="searchResult">查詢結果顯示在此</div>
        </div>

        <div id="keyboard-layout" class="keyboard-layout"></div>

    </div>

    <script>
        // 鍵盤佈局
        const keyboardKeys = [
            ['`', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-'],
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', '[', ']'],
            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';', '\'', '\\'],
            ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/', 'Shift', 'Backspace']
        ];
        
        const keyMap = {
            '`': '~', '1': '!', '2': '@', '3': '#', '4': '$', '5': '%', '6': '^', '7': '&', '8': '*', '9': '(', '0': ')', '-': '_',
            '[': '{', ']': '}', ';': ':', '\'': '"', '\\': '|', ',': '<', '.': '>', '/': '?'
        };

        // DOM 元素
        const practiceArea = document.getElementById('practice-area');
        const inputDisplay = document.getElementById('input-display');
        const phraseLookup = document.getElementById('phrase-lookup');
        const candidatesDisplay = document.getElementById('candidates-display');
        const modeDisplay = document.getElementById('mode-display');
        const searchInput = document.getElementById('searchInput');
        const searchResult = document.getElementById('searchResult');
        const paginationControls = document.getElementById('pagination-controls');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');

        // 輸入狀態變數
        let currentInput = '';
        let candidates = [];
        let selectedCandidateIndex = -1;
        let isEnglishMode = false;
        let shiftTimer = null;

        // 分頁相關變數
        let currentPage = 0;
        const candidatesPerPage = 10;
        let totalCandidates = 0;

        // 字典數據
        let primaryCodemap = {};
        let primaryReverseCodemap = {};
        let secondaryCodemap = {};
        let secondaryReverseCodemap = {};

        // 載入字典文件
        async function loadDictionaries() {
            try {
                const [primaryRes, secondaryRes] = await Promise.all([
                    fetch('3codes.txt'),
                    fetch('3codes2.txt')
                ]);
                const primaryText = await primaryRes.text();
                const secondaryText = await secondaryRes.text();

                const { dict: pDict, reverseDict: pReverseDict } = parseDict(primaryText);
                primaryCodemap = pDict;
                primaryReverseCodemap = pReverseDict;

                const { dict: sDict, reverseDict: sReverseDict } = parseDict(secondaryText);
                secondaryCodemap = sDict;
                secondaryReverseCodemap = sReverseDict;

                switchInputMethod('primary');
                console.log('Dictionaries loaded successfully.');
            } catch (error) {
                console.error('Failed to load dictionaries:', error);
                // 處理載入失敗的情況
            }
        }
        
        // 將字典數據解析成 JS 對象
        function parseDict(data) {
            const dict = {};
            const reverseDict = {};
            const lines = data.split('\n');
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length === 2) {
                    const code = parts[0].trim();
                    const chars = parts[1].trim();
                    if (code && chars) {
                        if (!dict[code]) {
                            dict[code] = [];
                        }
                        dict[code].push(chars);

                        chars.split('').forEach(char => {
                            if (!reverseDict[char]) {
                                reverseDict[char] = new Set();
                            }
                            reverseDict[char].add(code);
                        });
                    }
                }
            });
            for (const char in reverseDict) {
                reverseDict[char] = Array.from(reverseDict[char]);
            }
            return { dict, reverseDict };
        }

        let currentCodemap;
        let currentReverseCodemap;

        function switchInputMethod(method) {
            if (method === 'primary') {
                currentCodemap = primaryCodemap;
                currentReverseCodemap = primaryReverseCodemap;
            } else if (method === 'secondary') {
                currentCodemap = secondaryCodemap;
                currentReverseCodemap = secondaryReverseCodemap;
            }
            updateModeDisplay();
        }

        // 格式化編碼，將符號轉為全形
        function formatCode(code) {
            return code.replace(/,/g, '，').replace(/\./g, '。').replace(/\//g, '／').replace(/'/g, '’');
        }

        // 更新查碼區和練習區
        function updatePhraseLookup() {
            if (currentInput.length > 0) {
                const results = currentCodemap[currentInput] || [];
                const formattedCodes = results.map(char => {
                    const code = currentInput;
                    const formattedCode = formatCode(code);
                    return `「${char}」: ${formattedCode}`;
                });
                phraseLookup.textContent = formattedCodes.join('　　');
                if (formattedCodes.length === 0) {
                    phraseLookup.textContent = `找不到 ${currentInput} 的編碼。`;
                }
            } else {
                phraseLookup.textContent = '查碼區：顯示輸入後的可能詞組';
            }
        }
        
        // 更新候選字列表 (包含分頁邏輯)
        function updateCandidates() {
            candidatesDisplay.innerHTML = '';
            selectedCandidateIndex = -1;
            
            if (currentInput.length > 0) {
                candidates = currentCodemap[currentInput] || [];
                totalCandidates = candidates.length;
                
                const start = currentPage * candidatesPerPage;
                const end = start + candidatesPerPage;
                const pageCandidates = candidates.slice(start, end);

                if (pageCandidates.length > 0) {
                    pageCandidates.forEach((char, index) => {
                        const candidateItem = document.createElement('span');
                        candidateItem.className = 'candidate-item';
                        // 顯示編號從1開始
                        candidateItem.textContent = `${(start + index + 1) % 10 === 0 ? 0 : (start + index + 1) % 10}.${char}`;
                        candidateItem.dataset.index = start + index;
                        candidatesDisplay.appendChild(candidateItem);
                    });
                } else {
                    candidatesDisplay.textContent = '沒有候選字';
                }
                
                updatePaginationControls();
            } else {
                candidatesDisplay.textContent = '選字區：顯示候選字';
                paginationControls.style.display = 'none';
            }
        }
        
        // 更新分頁按鈕狀態
        function updatePaginationControls() {
            const totalPages = Math.ceil(totalCandidates / candidatesPerPage);
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
                prevPageBtn.disabled = (currentPage === 0);
                nextPageBtn.disabled = (currentPage >= totalPages - 1);
            } else {
                paginationControls.style.display = 'none';
            }
        }

        // 插入選中的文字
        function insertText(text) {
            practiceArea.textContent += text;
        }

        // 重置輸入狀態
        function resetInputState() {
            currentInput = '';
            candidates = [];
            selectedCandidateIndex = -1;
            currentPage = 0;
            inputDisplay.textContent = '';
            updatePhraseLookup();
            updateCandidates();
        }

        // 更新模式顯示
        function updateModeDisplay() {
            modeDisplay.textContent = isEnglishMode ? '英數模式' : '三碼模式';
        }

        // 更新鍵盤佈局
        function updateKeyboardDisplay() {
            const keyboardLayout = document.getElementById('keyboard-layout');
            keyboardLayout.innerHTML = '';
            
            keyboardKeys.forEach(row => {
                row.forEach(key => {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key';
                    if (key === 'Shift' || key === 'Backspace') {
                        keyDiv.classList.add(`key-${key.toLowerCase()}`);
                    }
                    
                    const mainText = isEnglishMode && keyMap[key] ? keyMap[key] : key;
                    const subText = isEnglishMode ? '' : (keyMap[key] || '');
                    
                    if (key.length > 1) {
                        keyDiv.textContent = key;
                    } else {
                        keyDiv.innerHTML = `<span class="key-text">${mainText.toUpperCase()}</span>`;
                        if (subText) {
                            keyDiv.innerHTML += `<span class="key-subtext">${subText.toUpperCase()}</span>`;
                        }
                    }
                    
                    keyboardLayout.appendChild(keyDiv);
                });
            });
        }

        // 處理鍵盤輸入
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            
            if (searchInput === document.activeElement) {
                return; // 讓反向查詢框正常運作
            }

            if (key === 'Shift') {
                if (!shiftTimer) {
                    shiftTimer = setTimeout(() => {
                        isEnglishMode = !isEnglishMode;
                        updateModeDisplay();
                        updateKeyboardDisplay();
                        shiftTimer = null;
                    }, 500); // 按住 0.5 秒切換模式
                }
            } else if (shiftTimer) {
                clearTimeout(shiftTimer);
                shiftTimer = null;
            }

            if (isEnglishMode) {
                if (key.length === 1 || key === 'Backspace' || key === 'Enter' || key === ' ') {
                    if (key === 'Backspace') {
                        practiceArea.textContent = practiceArea.textContent.slice(0, -1);
                    } else if (key === 'Enter') {
                        insertText('\n');
                    } else {
                        insertText(key);
                    }
                    event.preventDefault();
                }
                return;
            }

            const validKeys = "abcdefghijklmnopqrstuvwxyz,./;'[]\\-`".split('');
            const validNumKeys = "1234567890".split(''); // 包含0
            const currentCandidates = currentCodemap[currentInput] || [];

            // 處理選字
            if (currentCandidates.length > 0) {
                const numKeyIndex = validNumKeys.indexOf(key);
                if (numKeyIndex !== -1) {
                    const candidateIndex = currentPage * candidatesPerPage + numKeyIndex;
                    if (candidateIndex < currentCandidates.length) {
                        insertText(currentCandidates[candidateIndex]);
                        resetInputState();
                        event.preventDefault();
                    }
                } else if (key === 'PageDown' || key === ' ') { // 空白鍵翻頁
                    currentPage++;
                    updateCandidates();
                    event.preventDefault();
                } else if (key === 'PageUp') {
                    if (currentPage > 0) {
                        currentPage--;
                        updateCandidates();
                        event.preventDefault();
                    }
                }
            }
            
            // 處理三碼輸入
            if (validKeys.includes(key.toLowerCase()) || key === '\'' || key === ' ') {
                if (currentInput.length < 3) {
                    currentInput += key.toLowerCase();
                }
                updateInputDisplay();
                updateCandidates();
                updatePhraseLookup();
                event.preventDefault();
            } else if (key === 'Backspace') {
                if (currentInput.length > 0) {
                    currentInput = currentInput.slice(0, -1);
                    currentPage = 0; // 重置分頁
                }
                updateInputDisplay();
                updateCandidates();
                updatePhraseLookup();
                event.preventDefault();
            } else if (key === 'Enter') {
                if (currentInput.length > 0) {
                    insertText(currentInput);
                }
                resetInputState();
                event.preventDefault();
            }
        });

        // 處理滑鼠點擊候選字
        candidatesDisplay.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('candidate-item')) {
                const index = parseInt(target.dataset.index);
                if (index >= 0 && index < candidates.length) {
                    insertText(candidates[index]);
                    resetInputState();
                }
            }
        });
        
        // 處理分頁按鈕點擊
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                updateCandidates();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(totalCandidates / candidatesPerPage);
            if (currentPage < totalPages - 1) {
                currentPage++;
                updateCandidates();
            }
        });

        // 更新輸入顯示
        function updateInputDisplay() {
            inputDisplay.textContent = currentInput;
        }

        // --- 反向查詢事件處理 ---
        searchInput.addEventListener('input', (event) => {
            const charToSearch = searchInput.value;
            if (charToSearch.length === 1) {
                const codes = currentReverseCodemap[charToSearch];
                if (codes && codes.length > 0) {
                    // 格式化編碼後顯示
                    const formattedCodes = codes.map(code => formatCode(code));
                    searchResult.textContent = `編碼：　${formattedCodes.join('　')}`;
                } else {
                    searchResult.textContent = '找不到該漢字編碼。';
                }
            } else {
                searchResult.textContent = '查詢結果顯示在此';
            }
        });

        // 額外處理 Backspace 鍵清除
        searchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Backspace') {
                event.stopPropagation();
                if (searchInput.value.length === 1) {
                    searchInput.value = '';
                    searchResult.textContent = '查詢結果顯示在此';
                    event.preventDefault();
                }
            }
        });

        // 頁面載入時先初始化顯示
        loadDictionaries();
        updateKeyboardDisplay();
        updateInputDisplay();
    </script>
</body>
</html>
