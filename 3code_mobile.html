<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>‰∏âÁ¢º‰∏≠ÊñáËº∏ÂÖ•Ê≥ï - ÊâãÊ©üÊªëÂãïÈÅ∏Â≠óÁâà</title>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ----------------------------------------------------- */
        /* ÊâãÊ©üÂÑ™ÂåñÊ®£Âºè (Áï• - ËàáÂâçÊñáÁõ∏Âêå) */
        /* ----------------------------------------------------- */

        :root {
            --primary-color: #3f51b5;
            --text-color: #212121;
            --background-color: #f5f6fa;
            --container-bg: #ffffff;
            --key-bg: #e0e0e0;
            --key-active-bg: #a0a0a0;
            --special-key-bg: #cccccc;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; 
            outline: none;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--background-color);
            min-height: 100vh;
            padding-bottom: 490px; 
        }
        
        #toolbar {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            margin-bottom: 10px;
        }

        #toolbar button {
            flex-grow: 1;
            margin: 0 5px;
            padding: 10px 15px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s;
        }

        #toolbar button:active {
            background-color: #5c6bc0;
        }

        #app-container {
            width: 100%;
            max-width: 600px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #text-output {
            width: 100%;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 10px;
            padding: 10px;
            height: 30vh; 
            font-size: 1.5rem;
            line-height: 1.6;
            white-space: normal; 
            word-break: break-word;
            color: var(--text-color);
            cursor: text; 
            overflow-y: auto; 
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .cursor {
            display: inline-block;
            width: 0; 
            height: 1.2em; 
            vertical-align: middle;
            position: relative; 
            animation: blink 1s step-end infinite; 
        }

        .cursor::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 2px; 
            height: 100%;
            background-color: var(--primary-color); 
        }

        .composition-text {
            text-decoration: underline 2px solid var(--primary-color);
            font-weight: bold;
            display: inline;
        }
        
        #input-area {
            width: 100%;
            max-width: 600px;
            position: fixed;
            bottom: 355px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 101;
            background-color: var(--container-bg);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 1px 0 var(--border-color), 0 -4px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border-top: 1px solid var(--border-color); 
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        #main-input {
            width: 100%;
            padding: 8px;
            font-size: 1.2rem;
            min-height: 40px;
            line-height: 1.5; 
            border: none;
            border-bottom: 1px solid var(--border-color);
            background-color: #fafafa;
            color: #757575;
            white-space: nowrap;
            overflow-x: auto;
        }
        
        #candidate-display {
            display: flex;
            align-items: center;
            padding: 8px;
            gap: 12px; 
            white-space: nowrap; 
            overflow-x: scroll; 
            -webkit-overflow-scrolling: touch; 
            min-height: 60px;
        }
        
        #candidate-display::-webkit-scrollbar {
            display: none; 
        }

        #candidate-display span {
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            user-select: none;
            white-space: nowrap;
            font-size: 1.2rem; 
            flex-shrink: 0; 
            text-align: center;
        }
        
        #candidate-display span:active, #candidate-display span:hover {
            background-color: #e8eaf6;
        }

        .keyboard-container {
            width: 100%;
            max-width: 600px;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: #6a6f73;
            border-top: solid 1px #000;
            padding: 5px;
            padding-bottom: env(safe-area-inset-bottom, 5px);
        }

        .key-row {
            display: flex;
            justify-content: space-around;
            width: 100%;
            gap: 5px;
            margin-bottom: 5px;
        }

        .key {
            flex-grow: 1;
            flex-basis: 0; 
            padding: 0;
            border-radius: 6px;
            background-color: var(--key-bg);
            text-align: center;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s;
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
            line-height: 65px; 
            min-height: 65px;
            font-size: 1.8rem; 
            font-weight: bold;
        }

        .key.function-key {
            flex-basis: auto; 
            background-color: #c5cae9;
            line-height: 65px; 
            min-height: 65px;
            font-size: 1.8rem; 
            font-weight: bold; 
        }
        
        .key[data-code="lang_toggle"] {
            font-size: 1.2rem; 
        }
        
        .key[data-code="enter"] {
            font-size: 4.0rem; 
        }
        
        .key[data-code="case_shift"],
        .key[data-code="lang_toggle"],
        .key[data-code="symbol_toggle"], 
        .key[data-code="backspace"],
        .key[data-code="enter"] {
            flex-grow: 1.2; 
            flex-basis: 0; 
        }

        .key.space-key {
            flex-grow: 2.8; 
            flex-basis: 0;
            background-color: #c5cae9;
        }
        
        .key:active {
            background-color: var(--key-active-bg);
            color: #fff;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button id="copy-btn">üìã Ë§áË£ΩÊñáÂ≠ó</button>
        <button id="clear-btn">‚ùå Ê∏ÖÁ©∫ÊñáÂ≠ó</button>
    </div>
    
    <div id="app-container">
        <div id="text-output" spellcheck="false"></div>
    </div>
    
    <div id="input-area">
        <div id="main-input">Á∑®Á¢ºÈ°ØÁ§∫Âú®Ê≠§</div>
        <div id="candidate-display">ÂÄôÈÅ∏Â≠óÈ°ØÁ§∫Âú®Ê≠§...</div>
    </div>
    
    <div class="keyboard-container" id="keyboard-container">
    </div>

    <script>
        // --- ÁãÄÊÖãËÆäÊï∏ ---
        let currentCodemap = {};
        let currentReverseCodemap = {};
        let isEnglishMode = false;
        let isSymbolMode = false;
        let isShiftActive = false; 
        let committedText = ''; 
        let cursorPosition = 0; 
        let preferredOffset = -1; 
        
        // --- Ê∏∏Ê®ô HTML ÂÆöÁæ© ---
        const CURSOR_HTML = '<span id="main-cursor" class="cursor">\u200c</span>';
        const NON_BREAK_ANCHOR = '\ufeff'; 
        
        // --- ÈçµÁõ§È°ØÁ§∫ÂÖßÂÆπÊò†Â∞ÑË°® (Áï• - ‰øùÊåÅËàáÂâçÊñá‰∏ÄËá¥) ---
        const letter_maps = {
            'cn_normal': (key) => key.toUpperCase(), 
            'cn_shifted': (key) => key.toUpperCase(), 
            'en_normal': (key) => key.toLowerCase(), 
            'en_shifted': (key) => key.toUpperCase()
        };

        const key_display_maps = {
            'cn_normal': { 
                '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
                ';': 'Ôºõ', "'": '„ÄÉ', ',': 'Ôºå', '.': 'Ôºé', '/': 'Ôºè', 
                'lang_toggle': '‰∏âÁ¢º', 'case_shift': '‚áß', 'backspace': '‚å´', 'enter': '‚Üµ', ' ': ' ',
                'symbol_toggle': 'üåê' 
            },
            'cn_shifted': { 
                '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
                ';': 'Ôºõ', "'": '„ÄÉ', ',': 'Ôºå', '.': 'Ôºé', '/': 'Ôºè', 
                'lang_toggle': '‰∏âÁ¢º', 'case_shift': '‚¨Ü', 'backspace': '‚å´', 'enter': '‚Üµ', ' ': ' ',
                'symbol_toggle': 'üåê'
            },
            'en_normal': {
                '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
                ';': ';', "'": "'", ',': ',', '.': '.', '/': '/',
                'lang_toggle': 'En', 'case_shift': '‚áß', 'backspace': '‚å´', 'enter': '‚Üµ', ' ': ' ',
                'symbol_toggle': 'üåê'
            },
            'en_shifted': {
                '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
                ';': ';', "'": "'", ',': ',', '.': '.', '/': '/',
                'lang_toggle': 'En', 'case_shift': '‚¨Ü', 'backspace': '‚å´', 'enter': '‚Üµ', ' ': ' ',
                'symbol_toggle': 'üåê'
            },
            'symbol_normal': {
                '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
                'q': '!', 'w': '@', 'e': '#', 'r': '$', 't': '%', 'y': '^', 'u': '&', 'i': '*', 'o': '(', 'p': ')',
                'a': '_', 's': '-', 'd': '=', 'f': '+', 'g': '[', 'h': ']', 'j': '{', 'k': '}', 'l': '\\', ';': '‚Üë', "'": '|',
                'z': '`', 'x': '~', 'c': ':', 'v': '"', 'b': '<', 'n': '>', 'm': '?', ',': '‚Üê', '.': '‚Üì', '/': '‚Üí',
                'lang_toggle': '‰∏âÁ¢º', 'case_shift': '‚áß', 'backspace': '‚å´', 'enter': '‚Üµ', ' ': ' ',
                'symbol_toggle': 'üåé' 
            },
            'symbol_shifted': { 
                '1': '1', '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8', '9': '9', '0': '0',
                'q': '!', 'w': '@', 'e': '#', 'r': '$', 't': '%', 'y': '^', 'u': '&', 'i': '*', 'o': '(', 'p': ')',
                'a': '_', 's': '-', 'd': '=', 'f': '+', 'g': '[', 'h': ']', 'j': '{', 'k': '}', 'l': '\\', ';': '‚Üë', "'": '|',
                'z': '`', 'x': '~', 'c': ':', 'v': '"', 'b': '<', 'n': '>', 'm': '?', ',': '‚Üê', '.': '‚Üì', '/': '‚Üí',
                'lang_toggle': '‰∏âÁ¢º', 'case_shift': '‚¨Ü', 'backspace': '‚å´', 'enter': '‚Üµ', ' ': ' ',
                'symbol_toggle': 'üåé'
            }
        };

        function getCurrentDisplayMap() {
            let mode = isSymbolMode ? 'symbol' : (isEnglishMode ? 'en' : 'cn');
            let shift = isShiftActive ? 'shifted' : 'normal';
            return key_display_maps[`${mode}_${shift}`];
        }

        // --- Ê†∏ÂøÉÂ∑•ÂÖ∑ÂáΩÊï∏ÔºöÁÆ°ÁêÜÊ∏∏Ê®ôËàáËº∏Âá∫ (Áï• - ‰øùÊåÅËàáÂâçÊñá‰∏ÄËá¥) ---
        
        const textOutput = document.getElementById('text-output');
        const mainInput = document.getElementById('main-input');
        const candidateDisplay = document.getElementById('candidate-display');
        const keyboardContainer = document.getElementById('keyboard-container');
        const copyButton = document.getElementById('copy-btn');
        const clearButton = document.getElementById('clear-btn');
        
        const MAX_CODE_LENGTH = 3;
        let currentCode = '';
        let currentCandidates = [];
        
        // ÈÄô‰∫õÂáΩÊï∏ÔºàgetOutputChar, formatCode, formatComposition, setupTempDiv, getVisualCursorInfo,
        // updateOutputDisplay, mapDOMOffsetToTextIndex, handleTextTap, commitText, backspaceOutput,
        // moveCursor, parseCinData, handleChineseInput, handleEnglishInput, handleSymbolInput,
        // updateStateAndDisplay, showCandidates, selectCandidate, resetInputState, 
        // updateKeyboardDisplay, generateMobileKeyboard, copyTextToClipboard, clearOutputÔºâ
        // Êáâ‰øùÁïôËàáÂâçÊñáÂÆåÊï¥ÁöÑÁ®ãÂºèÁ¢ºÂçÄÂ°ä‰∏ÄËá¥„ÄÇ
        // ÁÇ∫ÁØÄÁúÅÁØáÂπÖÔºåÊ≠§ËôïÂÉÖÊîæËºâÂÖ•ÂáΩÊï∏Âíå‰∏ªË¶Å‰∫ã‰ª∂Áõ£ËÅΩ„ÄÇ

        // ------------------------------------------------------------------
        // *** Ê†∏ÂøÉ‰øÆÊîπÈÉ®ÂàÜÔºö‰øÆÂæ©Â§ñÈÉ®Ê™îÊ°àËÆÄÂèñÈÇèËºØ ***
        // ------------------------------------------------------------------

        function parseCinData(data) { 
            const newCodemap = {};
            const newReverseCodemap = {};
            const lines = data.trim().split('\n');
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 2 && !line.startsWith('#')) {
                    const code = parts[0].trim();
                    const char = parts[1].trim(); 
                    if (code && char) {
                        if (!newCodemap[code]) {
                            newCodemap[code] = [];
                        }
                        newCodemap[code].push(char);
                        
                        if (!newReverseCodemap[char]) {
                            newReverseCodemap[char] = [];
                        }
                        newReverseCodemap[char].push(code);
                    }
                }
            });
            return { newCodemap, newReverseCodemap };
        }


        // ÊÅ¢Âæ©Â§ñÈÉ®Ê™îÊ°àËÆÄÂèñÁöÑÂáΩÂºè (Â∑≤ÂåÖÂê´ÂÇôÁî®ÊñπÊ°à)
        async function loadSecondaryCodemap() {
            const fileName = './3codes2.txt'; 
            let textToParse = `# ÈÄôÊòØÂÇôÁî®ÁöÑÊ®°Êì¨Á∑®Á¢ºË°®\nqwe\tÊ∏¨Ë©¶\n`; 
            let statusMessage = 'Á∑®Á¢ºË°®ËºâÂÖ•ÊàêÂäü';

            try {
                // *** ÂòóË©¶‰ΩøÁî® fetch ËÆÄÂèñÂ§ñÈÉ®Ê™îÊ°à ***
                const response = await fetch(fileName);
                
                if (!response.ok) {
                     // Â¶ÇÊûúËÆÄÂèñÂ§±Êïó (‰æãÂ¶Ç 404 Êàñ CORS ÈåØË™§)
                     throw new Error(`ÁÑ°Ê≥ïËºâÂÖ•Â§ñÈÉ®Ê™îÊ°à (${response.status})„ÄÇË´ãÁ¢∫Ë™çÊ™îÊ°àÊòØÂê¶Â≠òÂú®Êñº‰º∫ÊúçÂô®„ÄÇ`);
                }
                
                // ÊàêÂäüÂèñÂæóÊ™îÊ°àÂÖßÂÆπ
                textToParse = await response.text();
                statusMessage = `Â∑≤ÊàêÂäüËºâÂÖ• ${fileName}`;

            } catch (error) {
                // ÊçïÊçâÂà∞ CORS ÊàñÂÖ∂‰ªñÁ∂≤Ë∑ØÈåØË™§
                console.error('Â§ñÈÉ®Ê™îÊ°àËÆÄÂèñÈåØË™§:', error.message);
                statusMessage = `ËºâÂÖ• ${fileName} Â§±ÊïóÔºåÂ∑≤ÂàáÊèõËá≥ÂÇôÁî®Á∑®Á¢º„ÄÇ`;
            }
            
            // ‰∏çË´ñÊòØÂê¶ÊàêÂäüËÆÄÂèñÂ§ñÈÉ®Ê™îÊ°àÔºåÈÉΩËß£ÊûêÂÖßÂÆπ
            try {
                const { newCodemap, newReverseCodemap } = parseCinData(textToParse);
                currentCodemap = newCodemap;
                currentReverseCodemap = newReverseCodemap;
            } catch (e) {
                // Â¶ÇÊûúÈÄ£ÂÇôÁî®Á∑®Á¢ºÈÉΩËß£ÊûêÂ§±Êïó
                currentCodemap = {};
                currentReverseCodemap = {};
                statusMessage = 'ÈåØË™§ÔºöÁ∑®Á¢ºË°®Ëß£ÊûêÂ§±Êïó„ÄÇ';
            }

            mainInput.textContent = statusMessage;
            resetInputState();
            updateOutputDisplay();
        }

        // ------------------------------------------------------------------
        // *** [Ë´ãËá™Ë°åË£úÂÖÖ] ÂÖ∂‰ªñËº∏ÂÖ•„ÄÅÊ∏∏Ê®ôËôïÁêÜ„ÄÅÈçµÁõ§ÁîüÊàêÁ≠âÂáΩÊï∏ ***
        // (‰øùÊåÅËàáÊÇ®‰∏ä‰∏ÄÂÄãÂÆåÊï¥Á®ãÂºèÁ¢ºÂçÄÂ°ä‰∏≠ÁöÑÂáΩÊï∏ÂÆöÁæ©‰∏ÄËá¥)
        // ------------------------------------------------------------------
        // ... [ÁúÅÁï•ÊâÄÊúâ‰∏≠ÈñìÂáΩÊï∏ÔºåË´ãÁ¢∫‰øùÂÆÉÂÄëÈÉΩÂú®ÊÇ®ÁöÑÂØ¶ÈöõÊ™îÊ°à‰∏≠]
        // ------------------------------------------------------------------

        // È†ÅÈù¢ÂïüÂãï
        document.addEventListener('DOMContentLoaded', () => {
            // ÈÄôË£°ÂÅáË®≠ generateMobileKeyboard, handleTextTap Á≠âÂáΩÊï∏Â∑≤ÂÆöÁæ©
            // generateMobileKeyboard(); 
            loadSecondaryCodemap(); 
            
            // Ê∏∏Ê®ôËß∏Á¢∞ÁßªÂãïÁöÑ‰∫ã‰ª∂Áõ£ËÅΩ
            // textOutput.addEventListener('click', handleTextTap);
            // textOutput.addEventListener('touchend', handleTextTap);
            
            // copyButton.addEventListener('click', copyTextToClipboard);
            // clearButton.addEventListener('click', clearOutput);
        });
        
    </script>
</body>
</html>